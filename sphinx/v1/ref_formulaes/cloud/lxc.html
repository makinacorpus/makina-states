

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LXC provision &mdash; Makina States 1.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Makina States 1.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Install &amp; configure the cloud ecosystem: Using salt runners" href="usage.html"/>
        <link rel="next" title="Baremetal (via ssh) provision aka salt/saltify" href="saltify.html"/>
        <link rel="prev" title="Makina-states cloud generic controller &amp; compute node &amp; vm documentation" href="generic.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../index.html" class="fa fa-home"> Makina States</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="simple">
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Custom states modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/modules/index.html">Execution modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/states/index.html">States modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/grains/index.html">makina-states grains modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/api/index.html">Api  modules</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Makina-states V1 documentation (OBSOLETE)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../index.html#usage">Usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html#reference">Reference</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Makina States</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Makina-states V1 documentation (OBSOLETE)</a> &raquo;</li>
      
          <li><a href="../../ref_index.html">Reference</a> &raquo;</li>
      
          <li><a href="../index.html">Makina-states Formulaes</a> &raquo;</li>
      
          <li><a href="index.html">Salt Cloud integration</a> &raquo;</li>
      
          <li><a href="usage.html">Install &amp; configure the cloud ecosystem: Using salt runners</a> &raquo;</li>
      
    <li>LXC provision</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../../_sources/v1/ref_formulaes/cloud/lxc.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="lxc-provision">
<h1>LXC provision<a class="headerlink" href="#lxc-provision" title="Permalink to this headline">¶</a></h1>
<p>As always, the configuration is done via a registry module: <a class="reference internal" href="../../../api/modules/mc_cloud_lxc.html#module-mc-cloud-lxc"><span>mc_cloud_lxc / lxc registry for compute nodes</span></a>.
To provision a new lxc provider, you need to:</p>
<blockquote>
<div><ul class="simple">
<li>Select a profile type (combination of backing mode (lvm/dir) and install
mode (clone/create)</li>
<li>Select a size profile if you are using block level backing stores (LVM)</li>
<li>Select a mode: mastersalt (localmaster+minion and a minion linked to
mastersalt) or salt (only a minion linked to master)</li>
<li>add an entry to your lxc container in pillar reflecting those choices plus
the other vm parameters.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>We create a default container in mastersalt node named <strong>makina-states-precise</strong>.
In cloning mode, this is the default origin container.</li>
<li>You can of course either start an lxc from scratch or begin with
a template like a barebone ubuntu which will be cloned at a start.</li>
<li>By default, we use the <strong>10.5/16* network on tje **lxcbr1</strong> bridge using the default gateway: <strong>10.5.0.1</strong>.</li>
<li>We use <strong>LVM</strong> as the default backing store in production, and the <strong>lxc</strong> volume group.</li>
<li>We use <strong>overlayfs</strong> with snapshot in development mode.</li>
</ul>
<p>To create new VMS, just configure your pillar and add some entries as follow</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">makina-states.services.cloud.lxc.targets.devhost10.local</span><span class="p p-Indicator">:</span>
  <span class="c1"># -&gt; autogenerated ip + mac + password stored in grains, name is id (mysupertest3.foo.co,</span>
  <span class="c1">#   will use default configured profile &amp; settings</span>
  <span class="l l-Scalar l-Scalar-Plain">mysupertest3.foo.com</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{}</span>
  <span class="c1"># explicit configuration and not using mastersalt mode</span>
  <span class="l l-Scalar l-Scalar-Plain">gfoobar.test.com</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">profile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">small</span>
    <span class="l l-Scalar l-Scalar-Plain">profile_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">lvm</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foobar</span>
    <span class="l l-Scalar l-Scalar-Plain">ip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.10.16</span>
  <span class="c1"># -&gt; autogenerated ip + mac</span>
  <span class="l l-Scalar l-Scalar-Plain">gfoobar4.test.com</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.10.15</span>
    <span class="l l-Scalar l-Scalar-Plain">profile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">small</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mastersalt</span>
    <span class="l l-Scalar l-Scalar-Plain">profile_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">lvm</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foobar</span>
  <span class="c1"># -&gt; autogenerated ip + mac + password stored in grains</span>
  <span class="l l-Scalar l-Scalar-Plain">gfoobar3.test.com</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.10.17</span>
    <span class="c1"># from_container: makina-states-precise -&gt; default</span>
    <span class="l l-Scalar l-Scalar-Plain">profile_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dir</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mastersalt</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foobar</span>
    <span class="l l-Scalar l-Scalar-Plain">bootsalt_branch</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">stable</span>
  <span class="l l-Scalar l-Scalar-Plain">gfoobar2.test.coma</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ip</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.10.17</span>
    <span class="c1"># image: ubuntu -&gt; default</span>
    <span class="l l-Scalar l-Scalar-Plain">profile_type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dir-scratch</span>
    <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mastersalt</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">foobar</span>
</pre></div>
</div>
<ul class="simple">
<li>The first line ends (after <strong>containers.</strong>) with your targeted minion id, where the lxc containers will be installed.</li>
<li>You have to assign the ip yourself to something that will be in the <strong>10.5/16</strong> network or the targeted minion</li>
<li>MAC is autogenerated if not providen, so you dont need to give one</li>
<li>IP is autogenerated if not providen, so you dont need to give one</li>
<li>PASSWORD autogenerated if not providen, so you dont need to give one</li>
<li>And the inner mappings define the container themselves.</li>
<li>Please note that the name in makina-corpus way must be the NickName FQDN.</li>
<li>Please do not use <strong>snapshot</strong> in production.</li>
</ul>
<div class="section" id="misc-notes">
<h2>Misc notes<a class="headerlink" href="#misc-notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Salt cloud profiles are just collections of default for your next provision.</li>
</ul>
<blockquote>
<div><ul>
<li><p class="first">The naming scheme of raw salt-cloud is ms-<strong>{encoded minion id}**[-**{size profile}</strong>]-<strong>{profile type}</strong>, eg profiles:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ms</span><span class="o">-</span><span class="n">devhost</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="nb">dir</span><span class="o">-</span><span class="n">scratch</span>
<span class="n">ms</span><span class="o">-</span><span class="n">devhost</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="nb">dir</span>
<span class="n">ms</span><span class="o">-</span><span class="n">devhost</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">small</span><span class="o">-</span><span class="n">lvm</span><span class="o">-</span><span class="n">scratch</span>
<span class="n">ms</span><span class="o">-</span><span class="n">devhost</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">medium</span><span class="o">-</span><span class="n">lvm</span>
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
<ul>
<li><p class="first">Those are the availables modes:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">salt:</th><td class="field-body">cf saltity modes</td>
</tr>
<tr class="field-even field"><th class="field-name">mastersalt:</th><td class="field-body">cf saltity modes</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">You can specify the makina-states branch to use with:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">bootsalt_branch:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">branch name</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Those are the sizes available in profiles</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">xxxtrem:</th><td class="field-body">2000g</td>
</tr>
<tr class="field-even field"><th class="field-name">xxtrem:</th><td class="field-body">1000g</td>
</tr>
<tr class="field-odd field"><th class="field-name">xtrem:</th><td class="field-body">500g</td>
</tr>
<tr class="field-even field"><th class="field-name">xxxlarge:</th><td class="field-body">100g</td>
</tr>
<tr class="field-odd field"><th class="field-name">large:</th><td class="field-body">20g</td>
</tr>
<tr class="field-even field"><th class="field-name">medium:</th><td class="field-body">10g</td>
</tr>
<tr class="field-odd field"><th class="field-name">small:</th><td class="field-body">5g</td>
</tr>
<tr class="field-even field"><th class="field-name">xsmall:</th><td class="field-body">3g</td>
</tr>
<tr class="field-odd field"><th class="field-name">xxsmall:</th><td class="field-body">1g</td>
</tr>
<tr class="field-even field"><th class="field-name">xxxsmall:</th><td class="field-body">500m</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Those are the types available in salt-cloud profiles</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">lvm-sratch:</th><td class="field-body">starting a lxc container from scratch (lvm backing)</td>
</tr>
<tr class="field-even field"><th class="field-name">lvm:</th><td class="field-body">cloning from existing container (lvm backing)</td>
</tr>
<tr class="field-odd field"><th class="field-name">dir-scratch:</th><td class="field-body">starting a lxc container from scratch (directory backing)</td>
</tr>
<tr class="field-even field"><th class="field-name">dir:</th><td class="field-body">cloning from existing container (directory backing)</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">overlayfs-scratch:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">starting a lxc container from scratch (overlayfs backing)</td>
</tr>
<tr class="field-even field"><th class="field-name">overlayfs:</th><td class="field-body">cloning from existing container (overlayfs backing)</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Attention, we need also that root from <strong>controller</strong> can connect both as saltmaster and
via ssh to either the <strong>computenode</strong> and the <strong>lxc</strong> node as root without password (sshkey).
Please not that the states normally do that setup for you but that may be
a start of investigation in case of problems.</p>
</li>
</ul>
</div>
<div class="section" id="remove-a-vm">
<h2>Remove a vm<a class="headerlink" href="#remove-a-vm" title="Permalink to this headline">¶</a></h2>
<p>To destroy at once boxes and minion keys on master:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>salt-cloud -d &lt;name&gt;
</pre></div>
</div>
</div>
<div class="section" id="get-infos-for-a-vm">
<h2>Get infos for a VM<a class="headerlink" href="#get-infos-for-a-vm" title="Permalink to this headline">¶</a></h2>
<p>To know specific settings for a vm, like the generated ip and password, you can
inspect the per vm settings.
Those settings are mainly used at creation time but not reapplied after further setup, so they may be obsoletes.
The only &#8220;live&#8221; settings are the gateway, the ip and ssh_reverse_proxy_port.</p>
<p>Please note that we also give here the <strong>ssh_reverse_proxy_port</strong> to access the vm
from the host:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mastersalt-call mc_cloud_lxc.get_settings_for_vm &lt;compute_node &lt;vm_name&gt;
</pre></div>
</div>
<p>For exemple, you can have something like that:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>autostart:
    True
backing:
    overlayfs
bootsalt_branch:
    master
bridge:
    lxcbr1
dnsservers:
    - 8.8.8.8
    - 4.4.4.4
domains:
    - nmdcarto51.test.com
from_container:
    makina-states-precise
gateway:
    10.5.0.1
image:
    ubuntu
ip:
    10.5.0.12
lxc_conf:
lxc_conf_unset:
mac:
    00:16:3e:00:f1:81
master:
    10.5.0.1
master_port:
    4606
mode:
    mastersalt
name:
    nmdcarto51.test.com
netmask:
    16
network:
    10.5.0.0
password:
    balh
profile:
    ms-devhost10-local-overlayfs
script_args:
    -C --from-salt-cloud --mastersalt-minion -b master
snapshot:
    True
ssh_gateway:
    devhost10.local
ssh_gateway_key:
    /root/.ssh/id_dsa
ssh_gateway_password:
    None
ssh_gateway_port:
    22
ssh_gateway_user:
    root
ssh_reverse_proxy_port:
    40000
ssh_username:
    ubuntu
sudo:
    True
users:
    - root
    - sysadmin
</pre></div>
</div>
</div>
<div class="section" id="detailed-documentation">
<span id="form-cloud-lxc"></span><h2>Detailed documentation<a class="headerlink" href="#detailed-documentation" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Exemple of the makina-states.cloud.lxc and how will integrate itself in the previous sequence:</dt>
<dd><blockquote class="first">
<div><dl class="docutils">
<dt>steps = [&#8216;spawn&#8217;,</dt>
<dd>&#8216;hostsfile&#8217;,
&#8216;sshkeys&#8217;,
&#8216;grains&#8217;,
&#8216;initial_setup&#8217;,
&#8216;initial_highstate&#8217;]</dd>
</dl>
</div></blockquote>
<ul class="last">
<li><p class="first">On the controller front:</p>
<blockquote>
<div><ul>
<li><p class="first">At run pre configured drivers specific hooks stage:</p>
<blockquote>
<div><ul class="simple">
<li>install the salt cloud lxc providers</li>
<li>install a cron that sync all defined images templates
from controller to compute nodes.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">At compute node post hook</p>
<blockquote>
<div><ul class="simple">
<li>install lxc</li>
<li>ensure images templates are installed</li>
<li>install lxc host specific grains</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">On the vm pre hook:</p>
<blockquote>
<div><ul class="simple">
<li>spawn the vm</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">on the vm post hook</p>
<blockquote>
<div><ul class="simple">
<li>configure specific lxc grains</li>
<li>configure host file</li>
<li>initial setup</li>
</ul>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="lxc-specific-usage">
<h2>LXC specific usage<a class="headerlink" href="#lxc-specific-usage" title="Permalink to this headline">¶</a></h2>
<p>All of those are integrated directly withe mc_cloud_{controller,compute_node,vm}
runners, you do not have to use them directly, this is purely for documentation
purpose.</p>
<div class="section" id="controller">
<h3>Controller<a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h3>
<p>Re run configuration of cloudcontroller:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mastersalt-run -lall mc_cloud_lxc.post_deploy_controller
</pre></div>
</div>
</div>
<div class="section" id="compute-node">
<h3>compute node<a class="headerlink" href="#compute-node" title="Permalink to this headline">¶</a></h3>
<p>Install lxc:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mastersalt-run -lall mc_cloud_lxc.install_vt &lt;computenode_id&gt;
</pre></div>
</div>
<p>This will call in turn those runners:</p>
<blockquote>
<div><ul class="simple">
<li>mc_cloud_lxc.configure_grains  &lt;computenode_id&gt;</li>
<li>mc_cloud_lxc.configure_install_lxc  &lt;computenode_id&gt;</li>
<li>mc_cloud_lxc.configure_images  &lt;computenode_id&gt;</li>
</ul>
</div></blockquote>
<p>This will also run the LXC images (templates) syncrhonnisation runner on that specific node.</p>
</div>
<div class="section" id="vm">
<h3>VM<a class="headerlink" href="#vm" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="saltify.html" class="btn btn-neutral float-right" title="Baremetal (via ssh) provision aka salt/saltify">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="generic.html" class="btn btn-neutral" title="Makina-states cloud generic controller &amp; compute node &amp; vm documentation"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014 -&gt; 2017, Mathieu Le Marec Pasquet, Régis Leroy &amp; Makina Corpus folks.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>