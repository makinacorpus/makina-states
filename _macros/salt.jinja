{#
# see for doc:
# - doc/ref/formulaes/_macros/salt.rst
#}
{%- set nodetypes_registry = salt['mc_nodetypes.registry']() %}
{%- set isLxc = nodetypes_registry.is.lxccontainer %}
{%- set isTravis = nodetypes_registry.is.travis %}
{%- set locs = salt['mc_locations.settings']() %}

{%- set resolver = salt['mc_utils.format_resolve'] %}

{%- set settings = salt['mc_salt.settings']() %}

{%- set ugs = salt['mc_usergroup.settings']() %}
{%- set group = ugs.group %}
{%- set groupId = ugs.groupId %}

{#-
# You can overrides this dict via the salt pillar entry 'confRepos', see bellow
# external base repositories to checkout
# Add also here the formumlas to checkout
# and if neccesary the symlink to wire on the salt root tree
#}
{%- set confRepos = settings.confRepos %}

{%- set saltCommonData = settings.saltCommonData %}
{%- set saltMinionData = settings.saltMinionData %}
{%- set saltMasterData = settings.saltMasterData %}

{#- mastersalt daemon overrides #}
{%- set mastersaltCommonData = settings.mastersaltCommonData %}
{%- set mastersaltMasterData = settings.mastersaltMasterData %}
{%- set mastersaltMinionData = settings.mastersaltMinionData %}

{#- common pillar overrides #}
{%- set mastersaltCommonPillar = settings.mastersaltCommonPillar %}
{%- set mastersaltMasterPillar = settings.mastersaltMasterPillar %}
{%- set mastersaltMinionPillar = settings.mastersaltMinionPillar %}
{%- set mastersalt_pillar      = settings.mastersalt_pillar      %}
{%- set saltCommonPillar       = settings.saltCommonPillar       %}
{%- set saltMasterPillar       = settings.saltMasterPillar       %}
{%- set saltMinionPillar       = settings.saltMinionPillar       %}
{%- set salt_pillar            = settings.salt_pillar            %}

{#-
########################################
# default exposed global variables
########################################
# SALT VARIABLES
#}
{%- set saltname       = settings.saltname       %}
{%- set saltprefix     = settings.saltprefix     %}
{%- set prefix         = settings.prefix         %}
{%- set projectsRoot   = settings.projectsRoot   %}
{%- set vagrantRoot    = settings.vagrantRoot    %}
{%- set dockerRoot     = settings.dockerRoot     %}
{%- set saltroot       = settings.saltroot       %}
{%- set saltRoot       = settings.saltRoot       %}
{%- set confPrefix     = settings.confPrefix     %}
{%- set cachePrefix    = settings.cachePrefix    %}
{%- set runPrefix      = settings.runPrefix      %}
{%- set logPrefix      = settings.logPrefix      %}
{%- set pillarRoot     = settings.pillarRoot     %}
{%- set msr            = settings.c.o.msr        %}
{%- set resetperms     = settings.c.o.resetperms %}
{%- set saltbinpath    = settings.saltbinpath    %}

{#- MASTERSALT VARIABLES #}
{%- set msaltname      =  settings.msaltname      %}
{%- set msaltprefix    =  settings.msaltprefix    %}
{%- set mprefix        =  settings.mprefix        %}
{%- set mprojects_root =  settings.mprojects_root %}
{%- set mvagrant_root  =  settings.mvagrant_root  %}
{%- set msaltroot      =  settings.msaltroot      %}
{%- set msaltRoot      =  settings.msaltRoot      %}
{%- set mconfPrefix    =  settings.mconfPrefix    %}
{%- set mcachePrefix   =  settings.mcachePrefix   %}
{%- set mrunPrefix     =  settings.mrunPrefix     %}
{%- set mlogPrefix     =  settings.mlogPrefix     %}
{%- set mpillarRoot    =  settings.mpillarRoot    %}
{%- set mmsr           =  settings.mmsr           %}
{%- set mresetperms    =  settings.mresetperms    %}
{%- set msaltbinpath   =  settings.msaltbinpath   %}

{#- mappings #}
{% set data_mappings = settings.data_mappings %}

{#- # dummies  states for orchestration #}
{% macro hooks() %}
{#- only here for orchestration purposes #}
dummy-pre-salt-checkouts:
  mc_proxy.hook: []
dummy-pre-salt-service-restart:
  mc_proxy.hook: []
dummy-post-salt-service-restart:
  mc_proxy.hook: []
dummy-salt-layout:
  mc_proxy.hook: []

{# salt master/minion state will attach to this for the minion to be configured
 # before being really restarted #}
dummy-pre-minion-service-restart:
  mc_proxy.hook:
    - require:
      - mc_proxy: dummy-pre-salt-service-restart
      - mc_proxy: dummy-pre-mastersalt-service-restart
dummy-post-minion-service-restart:
   mc_proxy.hook:
    - require:
      - mc_proxy: dummy-post-salt-service-restart
      - mc_proxy: dummy-post-mastersalt-service-restart
dummy-pre-master-service-restart:
  mc_proxy.hook:
    - require:
      - mc_proxy: dummy-pre-salt-service-restart
      - mc_proxy: dummy-pre-mastersalt-service-restart
dummy-post-master-service-restart:
   mc_proxy.hook:
    - require:
      - mc_proxy: dummy-post-salt-service-restart
      - mc_proxy: dummy-post-mastersalt-service-restart

dummy-pre-salt-minion-service-restart:
  mc_proxy.hook: []
dummy-pre-salt-master-service-restart:
  mc_proxy.hook: []

dummy-post-salt-minion-service-restart:
   mc_proxy.hook:
    - require_in:
      - mc_proxy: dummy-post-salt-service-restart
dummy-post-salt-master-service-restart:
   mc_proxy.hook:
    - require_in:
      - mc_proxy: dummy-post-salt-service-restart

dummy-pre-mastersalt-minion-service-restart:
  mc_proxy.hook: []
dummy-pre-mastersalt-master-service-restart:
  mc_proxy.hook: []
dummy-post-mastersalt-minion-service-restart:
   mc_proxy.hook:
    - require_in:
      - mc_proxy: dummy-post-mastersalt-service-restart
dummy-post-mastersalt-master-service-restart:
   mc_proxy.hook:
    - require_in:
      - mc_proxy: dummy-post-mastersalt-service-restart
dummy-pre-mastersalt-service-restart:
  mc_proxy.hook: []
dummy-post-mastersalt-service-restart:
  mc_proxy.hook: []
dummy-pre-mastersalt-checkouts:
  mc_proxy.hook: []
dummy-mastersalt-layout:
  mc_proxy.hook: []
{% endmacro %}

{#-
###############################
# Common installation stuff
###############################
#}
{% macro install_makina_states(mode='salt', adata=None) %}
{% if not adata %}
{%-   if mode=='salt'%}
{%-     set data = resolver(saltCommonData) %}
{%-   else %}
{%-     set data = resolver(mastersaltCommonData) %}
{%-    endif %}
{%- else %}
{%-   set data = resolver(adata) %}
{%- endif %}
{%- set localRoot = resolver('{salt_root}', data) %}
{%- set prefix = resolver('{prefix}', data) %}
{%- set confPrefix = resolver('{conf_prefix}', data) %}
{%- set cachePrefix = resolver('{cache_prefix}', data) %}
{%- set cachedir = resolver('{cachedir}', data) %}
{%- set runPrefix = resolver('{run_prefix}', data) %}
{%- set logPrefix = resolver('{log_prefix}', data) %}
{%- set pillarRoot = resolver('{pillar_root}', data) %}
{%- set localMsr = resolver('{salt_root}/makina-states', data) %}
{%- set repos = data['confRepos'] %}
{% for cur_name in  data['bins'] -%}
{%-  if cur_name == 'salt' %}
{%-    set src = 'salt' %}
{%-  else %}
{%-    set src = 'salt-wrapper' %}
{%- endif %}
salt-{{ data.name }}-{{cur_name}}-bin:
  file.managed:
    - name: {{ data.bin_dir }}/{{ data.pref_name }}{{cur_name}}
    - source: salt://makina-states/files/usr/bin/{{ src }}
    - mode: 755
    - makedirs: True
    - template: jinja
    - context:
        salt_mode: {{data.name}}
        service_name: common
    - bin_name: {{cur_name}}
    - require:
      - cmd: update-makinastates-{{ data.name }}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
{% endfor %}
{% for manfile in data['mans'] %}
{% set mansection = manfile.split('.')[1] %}
salt-man-{{manfile}}-{{ data.name }}:
  file.symlink:
    - name: /usr/share/man/man{{mansection}}/{{manfile}}
    - target: {{data.msr}}/src/salt/doc/man/{{manfile}}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
{% endfor %}

salt-{{ data.name }}-bootsalt-link-bin:
  file.symlink:
    - name: /usr/bin/boot-{{data.name}}.sh
    - target: {{ data.msr }}/_scripts/boot-salt.sh
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

salt-{{ data.name }}-{{ group }}:
  group.present:
    - name: {{ group }}
    - system: True
    {% if groupId %}- gid: {{ groupId }}{% endif %}

# retro compat
{{data.name}}-checkalive-job:
  cron.absent: []

{{data.name}}-sync-job:
  cron.absent: []

{{data.name}}-clean-job:
  cron.absent: []

{{data.name}}-remove-oldcrons:
  file.absent:
    - names:
      - /etc/cron.d/salt.sh

{% if salt['mc_controllers.mastersalt_mode']() %}
{{data.name}}-crons:
  file.managed:
    - name: /etc/cron.d/salt
    - source: ''
    - mode: 750
    - user: root
    - contents: |
                MAILTO="{{data.mailto}}"
                {% if data.cron_check_alive %}
                # salt checkalive job
                {{data.cron_minion_checkalive}} root {{settings.c.o.msr}}/_scripts/boot-salt.sh --check-alive --quiet -C --no-colors
                {% endif %}
                {% if data.cron_auto_sync %}
                # salt code synchronization job
                {{data.cron_sync_minute}} {{data.cron_sync_hour}} * * * root {{settings.c.o.msr}}/_scripts/boot-salt.sh --refresh-modules --quiet -C --no-colors
                {% endif %}
                {% if data.cron_auto_clean %}
                # salt code cleanup job
                {{data.cron_clean_minute}} {{data.cron_clean_hour}} * * * root {{settings.c.o.msr}}/_scripts/boot-salt.sh --cleanup --quiet -C --no-colors
                {% endif %}
{% endif %}
{#
{{data.name}}-upgrade-job:
  {% if not data.cron_auto_upgrade %}
  cron.absent:
  {% else %}
  cron.present:
    - identifier: "salt upgrade job"
    - hour: {{data.cron_upgrade_hour}}
    - minute: {{data.cron_upgrade_minute}}
  {% endif %}
    - name: {{settings.c.o.msr}}/_scripts/boot-salt.sh --upgrade -C --no-colors
#}

{# deactivated in favor of paas platform and manual work on mastersalt node... #}
{{data.name}}-upgrade-job:
  cron.absent:
    - identifier: "salt upgrade job"
    - hour: {{data.cron_upgrade_hour}}
    - minute: {{data.cron_upgrade_minute}}
    - name: {{settings.c.o.msr}}/_scripts/boot-salt.sh --upgrade -C --no-colors

{#-
# this is really factored
# idea is to create dirs, then requires daemons to issue the chmod
# without restarting them, otherwise the watch function will
# restart them everytime !
#}
salt-etc-{{ data.name }}-dirs:
  file.directory:
    - names:
      - {{ confPrefix }}
      - {{ confPrefix }}/master.d
      - {{ confPrefix }}/minion.d
    - user: root
    - group: {{ group }}
    - dir_mode: 0770
    - makedirs: True
    - require:
      - group: salt-{{ data.name }}-{{ group }}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
      - mc_proxy: dummy-{{data.name}}-layout

etc-{{ data.name }}-dirs:
  file.directory:
    - names:
      - {{ localRoot }}
      - {{ pillarRoot }}
      {# - {{ prefix }}/vagrant #}
    - user: root
    - group: {{ group }}
    - file_mode: "0770"
    - dir_mode: "0770"
    - makedirs: True
    - require:
      - group: salt-{{ data.name }}-{{ group }}

etc-{{ data.name }}-projects-dirs:
  file.directory:
    - names:
      - {{ localRoot }}/makina-projects
      - {{ prefix }}/projects
      {# - {{ prefix }}/vagrant #}
    - user: root
    - group: {{ group }}
    - file_mode: "0771"
    - dir_mode: "0771"
    - makedirs: True
    - require:
      - group: salt-{{ data.name }}-{{ group }}

open-{{ data.name }}-dirs:
  file.directory:
    - name: {{ locs.apps_dir }}
    - user: root
    - group: {{ group }}
  cmd.run:
    - name: chmod 0775 {{ locs.apps_dir }}
    - user: root
    - require:
      - file: open-{{ data.name }}-dirs
      - group: salt-{{ data.name }}-{{ group }}

{#- Keep those 3 first following in sync with buildout mr.developer content
# those repos are the one needed to bootstrap the core daemons #}
{% for i, rdata in repos.items() -%}
{%- set git = rdata['target']+'/.git' %}
{%- set rev = rdata.get('rev', None) %}
{%- set link = rdata.get('link', False) %}
salt-{{ data.name }}-{{ i }}:
{#- on next runs as we reset perms on repos, just set filemode=false
# do not use cwd as if dir does not exist, if will fail the entire state
# For formulas, also create the symlink if neccesary #}
  cmd.run:
    - name: cd "{{ rdata['target'] }}" && git config --local core.filemode false
    - require:
      - mc_proxy: dummy-pre-{{ data.name }}-checkouts
    - onlyif: ls -d "{{ git }}"
    - unless: if [ -d "{{ git }}" ];then cd "{{ rdata['target'] }}" && grep -q "filemode = false" .git/config;fi
  {# on each run, update the code -#}
  {% if rdata.get('update_checkout', False) %}
  git.latest:
    - name: {{ rdata['name'] }}
    - submodules: {{rdata['submodules']}}
    - target: {{ rdata['target'] }}
    - force_fetch: {{rdata.get('force_fetch', False)}}
    - force_reset: {{rdata.get('force_reset', False)}}
    {% if rev %}
    - rev: {{ rev }}
    {% endif %}
    - require:
      - cmd: salt-{{ data.name }}-{{ i }}
      - mc_proxy: install-recent-git-post
    - require_in:
      - file: salt-{{ data.name }}-{{ i }}
      - cmd: salt-{{ data.name }}-buildout-bootstrap
  {% endif %}
  {% if link %}
  file.symlink:
    - target:  {{link.target}}
    - name:  {{link.name}}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
  {% endif %}
{% endfor %}

salt-{{ data.name }}-makina-states-dirs:
  file.directory:
    - names:
      # first element is always /srv/salt/_<moddir>
      {% for i, data in data.saltmods.items() -%}
      - {{ data[0]}}
      {% endfor %}

{#- update makina-state #}
salt-{{ data.name }}-buildout-bootstrap:
  cmd.run:
    {#do nothing here, but keep the state for retro compat#}
    - onlyif: test x = y
    - name: echo skipped
    {#
    - name: |
            py="python";
            if [ -e "{{ data.venv }}/bin/python" ];then
              py="{{ data.venv }}/bin/python";
            fi;
            $py bootstrap.py
    - cwd: {{ data.msr }}
    #}
    - unless: test "$(cat buildout.cfg|md5sum|awk '{print $1}')" = "$(cat .saltchk)"
    - require_in:
      - cmd: update-makinastates-{{ data.name }}

update-makinastates-{{ data.name }}-venv:
  virtualenv.managed:
    - name: "{{data.venv_path}}"
    - system_site_packages: true
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

{{data.name}}-memcached-py:
  pip.installed:
    - name: pylibmc
    - bin_env: "{{data.venv_path}}"
    - onlyif: |
              test -e {{data.venv_path + '/bin/pip'}}
              test "x$({{data.venv_path + '/bin/python'}} -c 'import pylibmc' 1>/dev/null 2>/dev/null;echo $?)" != "x0"
    - watch:
      - virtualenv: update-makinastates-{{ data.name }}-venv
      - mc_proxy: memcached-post-install
    - watch_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

update-makinastates-{{ data.name }}-reqs:
  pip.installed:
    - requirements: "{{data.msr}}/requirements/requirements.txt"
    - bin_env: "{{data.venv_path}}"
    - upgrade: true
    - use_vt: true
    - unless: "{{data.msr}}/_scripts/check_pip.sh {{data.name}}"
    - require_in:
      - virtualenv: update-makinastates-{{ data.name }}-venv
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

{% for i in ['docker-py',
             'm2crypto',
             'salt',
             'salttesting'] %}
update-makinastates-{{ data.name }}-git-reqs-{{i}}:
  cmd.run:
    - name: |
            . {{data.venv_path}}/bin/activate
            pip install --no-deps -e .
    - require:
      - virtualenv: update-makinastates-{{ data.name }}-venv
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - onlyif: |
              set -e
              test -e .git/config
              "{{data.venv_path}}/bin/python" "{{data.msr}}/_scripts/modules_check.py"
    - user: root
    - cwd: "{{data.msr}}/src/{{i}}"
{% endfor %}

{% for i in ['lib', 'include', 'local', 'man', 'share', 'bin', 'src'] %}
{% set ldir = "{0}/{1}".format(data.msr, i) %}
{% set bdir = "{0}/nobackup/{1}".format(data.msr, i) %}
moveold-makinastates-{{ data.name }}-links{{i}}:
  cmd.run:
    - name: |
            if [ ! -e "{{data.msr}}/nobackup" ];then
              mkdir "{{data.msr}}/nobackup"
            fi
            mv "{{ldir}}" "{{bdir}}-$(date "+%F-%T-%N")"
    - target: "{{data.venv_path}}/{{i}}"
    - onlyif: |
              set -e
              test -e "{{ldir}}"
              test -d "{{ldir}}"
              test ! -h "{{ldir}}"
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - require:
      - virtualenv: update-makinastates-{{ data.name }}-venv
      - pip: update-makinastates-{{ data.name }}-reqs
update-makinastates-{{ data.name }}-links{{i}}:
  file.symlink:
    - name: "{{data.msr}}/{{i}}"
    - target: "{{data.venv_path}}/{{i}}"
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - require:
      - cmd: moveold-makinastates-{{ data.name }}-links{{i}}
      - virtualenv: update-makinastates-{{ data.name }}-venv
      - pip: update-makinastates-{{ data.name }}-reqs
{% endfor %}

update-makinastates-{{ data.name }}:
  cmd.run:
    {#do nothing here, but keep the state for retro compat#}
    - onlyif: test x = y
    - name: echo skipped
    {#
    - name: |
            bin/buildout &&\
            cat buildout.cfg|md5sum|awk '{print $1}'>.saltchk &&\
            touch "{{ data.msr }}/.restart_salt" &&\
            touch "{{ data.msr }}/.restart_msalt" &&\
            touch "{{ data.msr }}/.restart_salt_minion" &&\
            touch "{{ data.msr }}/.restart_msalt_minion"
    - cwd: {{ data.msr }}
    #}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - unless: test "$(cat buildout.cfg|md5sum|awk '{print $1}')" = "$(cat .saltchk)"

salt-{{ data.name }}-dirs-restricted:
  file.directory:
    - names:
      - {{ data.log_prefix }}
      - {{ data.run_prefix }}/{{ data.name }}
      - {{ data.cache_prefix }}
      - {{ data.conf_prefix }}/pki
    - msr: {{ data.msr }}
    - user: root
    - group: {{ group }}
    - file_mode: 0750
    - dir_mode: 2750
    - makedirs: True
    - require:
      - file: salt-{{ data.name }}-makina-states-dirs
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

# update makina-state
salt-{{ data.name }}-logrotate:
  file.managed:
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - template: jinja
    - name: {{ locs.conf_dir }}/logrotate.d/{{ data.name }}.conf
    - source: salt://makina-states/files/etc/logrotate.d/salt.conf
    - context:
        salt_mode: {{data.name}}
        service_name: common

{#- Fix permissions and ownerships
# recurse does not seem to work well to reset perms #}
etc-{{data.name}}-dirs-perms:
  cmd.run:
    - name: >
            {{settings.c.o.resetperms }}
            --dmode 0770 --fmode 0770 --no-acls
            --user "root" --group "{{ ugs.group }}"
            --paths {{ data.conf_prefix }}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
      - mc_proxy: dummy-pre-{{data.name}}-service-restart

{#- recurse does not seem to work well to reset perms #}
{{data.name}}-projects-dirs-perms:
  cmd.run:
    - name: >
            {{ settings.c.o.resetperms }}
            -u root -g "{{ ugs.group }}" --no-acls
            --dmode 0771 --fmode 0771
            --no-recursive
            --only-acls
            --paths "{{ data.projects_root }}"
    - require:
      - mc_proxy: dummy-pre-{{data.name}}-service-restart
      - cmd: etc-{{data.name}}-dirs-perms

{{data.name}}-dirs-perms:
  cmd.run:
    - name: >
            {{ settings.c.o.resetperms }}
            --dmode 0770 --fmode 0770 --no-acls
            --user "root" --group "{{ ugs.group }}"
            --users "root" --groups "{{ ugs.group }}"
            --paths "{{ data.salt_root }}"
            --paths "{{ data.pillar_root }}"
            --excludes "{{ data.salt_root }}.*\/files($|\/.*)"
            --excludes "{{ data.salt_root }}/_grains"
    - require:
      - mc_proxy: dummy-pre-{{data.name}}-service-restart
      - cmd: etc-{{data.name}}-dirs-perms
      - cmd: {{data.name}}-projects-dirs-perms

{{data.name}}-dirs-restricted-perms:
  cmd.run:
    - name: >
            {{ resetperms }}
            --fmode 0750 --dmode 0750 --no-acls
            --user "root" --group "{{ ugs.group }}"
            --users "root" --groups "{{ ugs.group }}"
            --paths "{{ data.log_prefix }}"
            --paths "{{ data.run_prefix }}/{{data.name}}"
            --paths "{{ data.cache_prefix }}"
            --paths "{{ data.cache_prefix }}"/{{data.name}}-minion
            --paths "{{ data.cache_prefix }}"/{{data.name}}-master
            --paths "{{ data.conf_prefix }}/pki"
            --excludes "mastersalt.*\/jobs\/.*"
    - require:
      - cmd: {{data.name}}-dirs-perms
      - cmd: etc-{{data.name}}-dirs-perms
      - file: salt-{{data.name}}-dirs-restricted
      - mc_proxy: dummy-pre-{{data.name}}-service-restart

{% set upaths = [data.salt_root + '/makina-states/files'] %}
{{data.name}}-dirs-urestricted-perms:
  cmd.run:
    - name: setfacl -R -b -k {% for a in upaths %} "{{a}}"{% endfor%}
    - require:
      - cmd: {{data.name}}-dirs-perms
      - cmd: etc-{{data.name}}-dirs-perms
      - file: salt-{{data.name}}-dirs-restricted
      - cmd: {{data.name}}-dirs-restricted-perms
      - mc_proxy: dummy-pre-{{data.name}}-service-restart
{% endmacro %}

{#-
# SALT DAEMON MACRO
#}
{% macro install_salt_common_daemon(adata) %}
{% set data = resolver(adata) %}
{%- set localRoot = resolver('{salt_root}', data) %}
{%- set prefix = resolver('{prefix}', data) %}
{%- set confPrefix = resolver('{conf_prefix}', data) %}
{%- set cachePrefix = resolver('{cache_prefix}', data) %}
{%- set cachedir = resolver('{cachedir}', data) %}
{%- set runPrefix = resolver('{run_prefix}', data) %}
{%- set logPrefix = resolver('{log_prefix}', data) %}
{%- set pillarRoot = resolver('{pillar_root}', data) %}
{%- set localMsr = resolver('{salt_root}/makina-states', data) %}
salt-{{ data.daemon_name }}-conf-global:
  file.managed:
    - name: {{ confPrefix }}/{{ data.service_name }}.d/00_global.conf
    - template: jinja
    - makedirs: true
    - source: salt://makina-states/files/etc/salt/{{ data.service_name }}.d/00_global.conf
    - context:
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

# retro compat
{{data.name}}-{{data.daemon_name}}-restart-job:
  cron.absent:
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

{% if salt['mc_controllers.mastersalt_mode']() %}
{{data.service_name}}-remove-oldcrons:
  file.absent:
    - names:
      - /etc/cron.d/saltrestart-{{data.service_name}}.sh
{{data.name}}-{{data.service_name}}-restart-crons:
  file.absent:
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - name: /etc/cron.d/saltrestart-{{data.service_name}}
{# deactivated for now as now the daemons are stables and checked via check alive
   we do not need to reload them everyday which can cause mass reconnect issues
  file.managed:
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
    - name: /etc/cron.d/saltrestart-{{data.service_name}}
    - source: ''
    - mode: 750
    - user: root
    - contents: |
                MAILTO="{{data.mailto}}"
                {% if data.cron_auto_restart %}
                # salt {{data.service_name}} auto restart job
                {{data['cron_{0}_restart_minute'.format(data['service_name'])]}} {{data['cron_{0}_restart_hour'.format(data['service_name'])]}} * * * root {{settings.c.o.msr}}/_scripts/boot-salt.sh --restart-{{data.service_name}}s -C --no-colors
                {% endif %}
#}
{% endif %}

salt-{{ data.daemon_name }}-conf:
  file.managed:
    - name: {{ confPrefix }}/{{ data.service_name }}
    - template: jinja
    - source: salt://makina-states/files/etc/salt/{{ data.service_name }}
    - context:
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
      - mc_proxy: dummy-pre-{{ data.daemon_name }}-service-restart

salt-{{ data.daemon_name }}-unit:
  file.managed:
    - name: /etc/systemd/system/{{ data.daemon_name }}.service
    - template: jinja
    - source:  salt://makina-states/files/etc/systemd/system/salt-{{ data.service_name }}.service
    - mode: "644"
    - makedirs: true
    - saltname: {{ data.name }}
    - saltconfig: {{ confPrefix }}
    - context:
        root: {{ data.msr }}
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

      - mc_proxy: dummy-pre-{{ data.daemon_name }}-service-restart

{% if grains['os'] == 'Debian' -%}
salt-{{ data.daemon_name }}-job:
  file.managed:
    - name: {{ data['initd_dir'] }}/{{ data.daemon_name }}
    - template: jinja
    - source:  salt://makina-states/files/etc/init.d/salt-{{ data.service_name }}
    - mode: 755
    - saltname: {{ data.name }}
    - saltconfig: {{ confPrefix }}
    - context:
        salt_mode: {{data.name}}
        root: {{ data.msr }}
        service_name: {{data.service_name}}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

      - mc_proxy: dummy-pre-{{ data.daemon_name }}-service-restart
{% endif %}

{% if grains['os'] == 'Ubuntu' -%}
salt-{{ data.daemon_name }}-job:
  file.managed:
    - name: {{ data.upstart_dir }}/{{ data.daemon_name }}.conf
    - template: jinja
    - source:  salt://makina-states/files/etc/init/salt-{{ data.service_name }}.conf
    - saltconfig: {{ confPrefix }}
    - saltname: {{ data.name }}
    - context:
        salt_mode: {{data.name}}
        root: {{ data.msr }}
        service_name: {{data.service_name}}
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
      - mc_proxy: dummy-pre-{{ data.daemon_name }}-service-restart
{% endif %}

salt-{{ data.daemon_name }}-cache:
  file.directory:
    - name: {{ cachedir }}
    - makedirs: True
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

salt-{{ data.daemon_name }}-pki:
  file.directory:
    - name: {{ confPrefix }}/pki/{{ data.service_name }}
    - makedirs: True
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

salt-{{ data.daemon_name }}-sock-dir:
  file.directory:
    - name: {{ runPrefix }}/{{data.name}}/{{ data.service_name }}
    - makedirs: True
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

salt-{{ data.daemon_name }}-logs:
  file.managed:
    - context:
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - names:
      - {{ logPrefix }}/key
      - {{ logPrefix }}/{{ data.daemon_name }}
      - {{ logPrefix }}/syndic.log
    - makedirs: true
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

# done to mitigate authentication errors on restart
salt-restart-{{ data.daemon_name }}:
  cmd.run:
    - name: |
            service {{ data.daemon_name }} stop;{% if salt['mc_controllers.masterless']() %}
            service {{ data.daemon_name }} start && \
            echo "Reloading {{ data.daemon_name }}" \
            sleep 5 && \
            rm -f "{{ data.msr }}/.restart_{{ data.daemon_name }}"
            {%endif%}
    - onlyif: ls "{{ data.msr }}/.restart_{{ data.daemon_name }}"
    - require:
      - mc_proxy: dummy-pre-{{ data.daemon_name }}-service-restart
      - mc_proxy: memcached-post-restart
    - require_in:
      - dummy-post-{{ data.daemon_name }}-service-restart

{% if salt['mc_controllers.masterless']() %}
asalt-{{ data.daemon_name }}:
  service.disabled:
    - name: {{ data.daemon_name }}
    - require:
      - mc_proxy: dummy-post-{{ data.name }}-service-restart
      - mc_proxy: dummy-post-{{ data.service_name }}-service-restart
salt-{{ data.daemon_name }}:
  service.dead:
    - name: {{ data.daemon_name }}
    - require:
      - service: asalt-{{ data.daemon_name }}
      - mc_proxy: dummy-post-{{ data.name }}-service-restart
      - mc_proxy: dummy-post-{{ data.service_name }}-service-restart
{% else %}
salt-{{ data.daemon_name }}:
  service.running:
    - name: {{ data.daemon_name }}
    - enable: True
    - require:
      - mc_proxy: dummy-post-{{ data.name }}-service-restart
      - mc_proxy: dummy-post-{{ data.service_name }}-service-restart
{%endif%}

salt-{{ data.daemon_name }}-remove-minionid:
  file.absent:
    - names:
      - {{ data.conf_prefix }}/minion_id
      - {{locs.conf_dir}}/salt/minion_id
      - {{locs.conf_dir}}/mastersalt/minion_id
    - require_in:
      - mc_proxy: dummy-post-{{ data.name }}-service-restart
      - mc_proxy: dummy-post-{{ data.service_name }}-service-restart
{% endmacro %}

{#-
########################
# Install a salt master
########################
#}
{% macro install_master(mode='salt', data=None, service_name='master') %}
{% if not data -%}
{%- set data = data_mappings[service_name].get(
  mode,  data_mappings[service_name]['salt']) %}
{%- endif %}
{{ install_salt_common_daemon(adata=data) }}

salt-{{ data.name }}-remove-minionid:
  file.absent:
    - names:
      - {{ data.conf_prefix }}/minion_id
      - {{locs.conf_dir}}/salt/minion_id
      - {{locs.conf_dir}}/mastersalt/minion_id
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart

{% for cur_name in  [
  'roster',
] -%}
salt-{{ data.name }}-{{cur_name}}-bin:
  file.managed:
    - name: {{ data.conf_prefix }}/{{cur_name}}
    - source: salt://makina-states/files/etc/salt/{{cur_name}}
    - mode: 700
    - makedirs: True
    - template: jinja
    - context:
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - require:
      - cmd: update-makinastates-{{ data.name }}
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
{% endfor %}

# specific vagrant vm settings
{% if salt['mc_nodetypes.is_devhost']() %}
salt-{{ data.daemon_name }}-conf-devhost-global:
  file.managed:
    - name: {{ data.conf_prefix }}/{{ data.service_name }}.d/10_devhost.conf
    - template: jinja
    - makedirs: true
    - context:
        salt_mode: {{data.name}}
        service_name: {{data.service_name}}
    - source: salt://makina-states/files/etc/salt/{{ data.service_name }}.d/10_devhost.conf
    - require:
      - mc_proxy: dummy-{{data.name}}-layout
    - require_in:
      - mc_proxy: dummy-pre-{{ data.name }}-service-restart
{% endif %}
{% endmacro %}

{#
########################
# install a salt minion
########################
#}
{% macro install_minion(mode='salt', data=None, service_name='minion') %}
{% if not data %}
{%- set data = data_mappings[service_name].get(
  mode,  data_mappings[service_name]['salt']) %}
{%- endif %}
{{ install_salt_common_daemon(adata=data) }}
{% endmacro %}
# vim: set nofoldenable:
